name: ğŸš€ Compilar, probar y publicar versiÃ³n

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-test-publish:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ§© Configurar entorno .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 7.0.x

      - name: ğŸ“¦ Restaurar dependencias
        run: dotnet restore

      - name: ğŸ› ï¸ Compilar aplicaciÃ³n
        run: dotnet build --configuration Release --no-restore

      - name: ğŸ§ª Ejecutar pruebas unitarias con cobertura
        run: |
          dotnet test --configuration Release --no-build \
            /p:CollectCoverage=true \
            /p:CoverletOutput=TestResults/coverage/ \
            /p:CoverletOutputFormat=lcov

      - name: ğŸ“Š Instalar reportgenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: ğŸ“ˆ Generar reporte HTML de cobertura
        run: |
          reportgenerator -reports:./**/coverage.info -targetdir:coverage-report -reporttypes:Html

      - name: ğŸš€ Publicar cobertura en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage-report

      - name: ğŸ·ï¸ Crear Release automÃ¡tico
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "VersiÃ³n automÃ¡tica ${{ github.run_number }}"
          body: |
            ğŸš€ Nueva versiÃ³n publicada automÃ¡ticamente.
            - CompilaciÃ³n exitosa
            - Tests ejecutados y reporte de cobertura disponible en GitHub Pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
